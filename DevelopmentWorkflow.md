# ğŸ§± CryptoTrading.Backtester â€” Architecture & Development Workflow

åŠ å¯†è²¨å¹£å›æ¸¬ç³»çµ± â€” æ¶æ§‹èˆ‡é–‹ç™¼æµç¨‹æ–‡ä»¶  
_Last updated: 2025-10-27_

---

## 1. Design Goals è¨­è¨ˆç›®æ¨™

âœ… ç›®å‰éšæ®µç›®æ¨™

âœ… å¾ Binance API æ‹‰å–ä¸¦å„²å­˜ K ç·šæ­·å²è³‡æ–™ï¼ˆè‡³ MSSQL Docker DBï¼‰

âœ… é«˜æ•ˆèƒ½å›æ¸¬å¼•æ“ï¼ˆæ”¯æ´æ³¨å…¥ä¸åŒç­–ç•¥ï¼‰

âœ… å¯é‡æ¸¬æ•ˆèƒ½åˆ†æé»ï¼ˆè¨˜éŒ„åŸ·è¡Œæ™‚é–“èˆ‡è³‡æºä½¿ç”¨ï¼‰

âœ… é«˜å¯æ¸¬è©¦æ€§ï¼ˆç­–ç•¥èˆ‡å›æ¸¬é‚è¼¯çš†å¯å–®å…ƒæ¸¬è©¦ï¼‰

âœ… å…·å‚™è³‡æ–™é‡ç”¨èƒ½åŠ›ï¼ˆDB å¿«å–é¿å…é‡è¤‡è«‹æ±‚ Binance APIï¼‰

## 2. System Overview ç³»çµ±æ¶æ§‹ç¸½è¦½

CryptoTrading/
â”œâ”€â”€ CryptoTrading.Core/ # ğŸ”¥ æ ¸å¿ƒé‚è¼¯ï¼ˆç´”å•†æ¥­é‚è¼¯ï¼Œä¸ä¾è³´å¤–éƒ¨ï¼‰
â”‚ â”œâ”€â”€ Backtest/
â”‚ â”‚ â”œâ”€â”€ BacktestEngine.cs # æ§åˆ¶æ•´å€‹å›æ¸¬æµç¨‹
â”‚ â”‚ â”œâ”€â”€ StrategyBase.cs # ç­–ç•¥åŸºåº•é¡åˆ¥
â”‚ â”‚ â”œâ”€â”€ MovingAverageStrategy.cs # ç¯„ä¾‹ï¼šå‡ç·šç­–ç•¥
â”‚ â”‚ â””â”€â”€ PerformanceAnalyzer.cs # åˆ†æå ±é…¬ã€å¤æ™®å€¼ã€æœ€å¤§å›æ’¤ç­‰ç¸¾æ•ˆ
â”‚ â”‚
â”‚ â”œâ”€â”€ Models/
â”‚ â”‚ â”œâ”€â”€ Candle.cs # å–®æ ¹ K ç·šè³‡æ–™çµæ§‹
â”‚ â”‚ â”œâ”€â”€ TradeRecord.cs # å–®ç­†äº¤æ˜“è¨˜éŒ„
â”‚ â”‚ â”œâ”€â”€ BacktestResult.cs # å›æ¸¬çµæœå½™ç¸½
â”‚ â”‚ â””â”€â”€ Symbol.cs # å¹£ç¨®è³‡è¨Šï¼ˆæ–°å¢ï¼‰
â”‚ â”‚
â”‚ â”œâ”€â”€ Utils/
â”‚ â”‚ â”œâ”€â”€ PerformanceTimer.cs # æ¸¬é‡åŸ·è¡Œæ™‚é–“å·¥å…·
â”‚ â”‚ â””â”€â”€ MathHelper.cs # æ•¸å­¸èˆ‡çµ±è¨ˆè¼”åŠ©å‡½å¼
â”‚
â”œâ”€â”€ CryptoTrading.Infrastructure/ # ğŸŒ å¤–éƒ¨è³‡æºï¼ˆAPIã€DBã€Loggingï¼‰
â”‚ â”œâ”€â”€ Binance/
â”‚ â”‚ â”œâ”€â”€ BinanceApiClient.cs # å‘¼å« Binance API
â”‚ â”‚ â”œâ”€â”€ BinanceEndpoints.cs # çµ±ä¸€ç®¡ç† URL
â”‚ â”‚ â””â”€â”€ BinanceDataMapper.cs # JSON â†’ Candle æ¨¡å‹
â”‚ â”‚
â”‚ â”œâ”€â”€ Database/
â”‚ â”‚ â”œâ”€â”€ CryptoTradingDbContext.cs # EF Core DbContext æˆ– Dapper Connection
â”‚ â”‚ â”œâ”€â”€ Migrations/ # è³‡æ–™åº«çµæ§‹
â”‚ â”‚ â”œâ”€â”€ Entities/
â”‚ â”‚ â”‚ â”œâ”€â”€ CandleEntity.cs
â”‚ â”‚ â”‚ â””â”€â”€ SymbolEntity.cs
â”‚ â”‚ â”œâ”€â”€ Repositories/
â”‚ â”‚ â”‚ â”œâ”€â”€ ICandleRepository.cs
â”‚ â”‚ â”‚ â””â”€â”€ CandleRepository.cs # æ–°å¢ï¼šç®¡ç†æ­·å²è³‡æ–™å­˜å–
â”‚ â”‚ â””â”€â”€ DatabaseExtensions.cs # DI è¨»å†Š + é€£ç·šè¨­å®š
â”‚ â”‚
â”‚ â”œâ”€â”€ Http/
â”‚ â”‚ â””â”€â”€ HttpHelper.cs # åŒ…è£ HttpClient è«‹æ±‚ï¼ˆå«éŒ¯èª¤/é‡è©¦/Logï¼‰
â”‚ â”‚
â”‚ â”œâ”€â”€ Logging/
â”‚ â”‚ â”œâ”€â”€ NLog.config # NLog è¨­å®š
â”‚ â”‚ â””â”€â”€ LoggingExtensions.cs # DI æ“´å……
â”‚ â”‚
â”‚ â””â”€â”€ Exceptions/
â”‚ â””â”€â”€ ApiException.cs # è‡ªè¨‚ä¾‹å¤–ï¼ˆåŒ…è£ API éŒ¯èª¤ï¼‰
â”‚
â”œâ”€â”€ CryptoTrading.WebApi/ # ğŸŒ Web å±¤ï¼ˆAPI + Middlewareï¼‰
â”‚ â”œâ”€â”€ Middlewares/
â”‚ â”‚ â”œâ”€â”€ RequestLoggingMiddleware.cs # è«‹æ±‚/å›æ‡‰ç´€éŒ„
â”‚ â”‚ â”œâ”€â”€ MiddlewareExtensions.cs # ä¸­ä»‹è»Ÿé«”æ“´å……æ–¹æ³•
â”‚ â”‚ â””â”€â”€ ErrorHandlingMiddleware.cs # æ•æ‰ä¾‹å¤–ä¸¦çµ±ä¸€å›å‚³ JSON
â”‚ â”‚
â”‚ â”œâ”€â”€ Controllers/
â”‚ â”‚ â”œâ”€â”€ BinanceController.cs # æ‹‰å– K ç·šè³‡æ–™ + å„²å­˜ DB
â”‚ â”‚ â””â”€â”€ CandleController.cs # æŸ¥è©¢å„²å­˜çš„æ­·å²è³‡æ–™
â”‚ â”‚
â”‚ â”œâ”€â”€ appsettings.json # DB/Logging è¨­å®š
â”‚ â”œâ”€â”€ Program.cs # ç¨‹å¼é€²å…¥é»ï¼ˆè¨»å†Š DI/Middleware/Serilogï¼‰
â”‚ â””â”€â”€ Serilog.config # WebAPI Log è¨­å®š
â”‚
â””â”€â”€ Tests/ # ğŸ§ª æ¸¬è©¦å±¤
â”œâ”€â”€ BacktestEngineTests.cs
â”œâ”€â”€ BinanceApiTests.cs
â”œâ”€â”€ CandleRepositoryTests.cs
â””â”€â”€ MiddlewareTests.cs

## ğŸ§  3.æ ¸å¿ƒæ¨¡çµ„è¨­è¨ˆèªªæ˜

| æ¨¡çµ„                    | åŠŸèƒ½                                     | å‚™è¨»               |
| ----------------------- | ---------------------------------------- | ------------------ |
| **BinanceApiClient**    | å‘¼å« Binance REST APIï¼Œæ‹‰å–æ­·å² K ç·šè³‡æ–™ | ä½¿ç”¨ `HttpClient`  |
| **BinanceDataMapper**   | å°‡ JSON array è½‰æˆ `List<Candle>`        | å°è£è³‡æ–™è½‰æ›é‚è¼¯   |
| **BacktestEngine**      | æ§åˆ¶æ•´å€‹å›æ¸¬æµç¨‹                         | å¯æ³¨å…¥ç­–ç•¥         |
| **StrategyBase**        | å®šç¾©ç­–ç•¥ä»‹é¢ï¼ˆ`GenerateSignal`ï¼‰         | å¯æ›ç­–ç•¥           |
| **PerformanceAnalyzer** | è¨ˆç®—å›æ¸¬ç¸¾æ•ˆ                             | å ±é…¬ç‡ã€æœ€å¤§å›æ’¤ç­‰ |
| **PerformanceTimer**    | æ¸¬é‡å›æ¸¬æ•ˆèƒ½                             | stopwatch-based    |

## 4.è³‡æ–™åº«å±¤ï¼ˆDatabase Layerï¼‰

| é¡åˆ¥ / æª”æ¡ˆ                | åŠŸèƒ½                                                | å‚™è¨»                                       |
| -------------------------- | --------------------------------------------------- | ------------------------------------------ |
| **CryptoTradingDbContext** | æä¾› Entity Framework Core çš„è³‡æ–™åº«é€£ç·šèˆ‡è³‡æ–™è¡¨é…ç½® | å¯æ”¹ç‚º Dapper                              |
| **CandleEntity**           | æ˜ å°„è‡³è³‡æ–™è¡¨ `Candles`                              | åŒ…å« Symbolã€OpenTimeã€Openã€Closeã€Volume |
| **CandleRepository**       | æ–°å¢/æŸ¥è©¢æ­·å²è³‡æ–™ï¼ˆæ”¯æ´ Upsertï¼‰                    | å¯é¿å…é‡è¤‡å­˜è³‡æ–™                           |
| **DatabaseExtensions**     | åœ¨ `Program.cs` è¨»å†Š DBContext èˆ‡é€£ç·šå­—ä¸²           | é€£ç·šè‡³ Docker ç‰ˆ MSSQL                     |
| **docker-compose.yml**     | å•Ÿå‹• MSSQL å®¹å™¨èˆ‡è³‡æ–™æŒä¹…åŒ– Volume                  | è¦‹ä¸‹ç¯€                                     |

## 5. è³‡æ–™æµ

flowchart TD
A[BinanceApiClient] -->|REST JSON| B[BinanceDataMapper]
B -->|List<Candle>| C[BacktestEngine]
C --> D[StrategyBase]
D --> E[TradeRecord]
E --> F[PerformanceAnalyzer]
F -->|Result| G[ConsoleRunner]

## 6. é–‹ç™¼æµç¨‹å»ºè­°

| éšæ®µ                      | ç›®æ¨™                                           | ä»»å‹™                                          |
| ------------------------- | ---------------------------------------------- | --------------------------------------------- |
| **1ï¸âƒ£ åˆå§‹åŒ–å°ˆæ¡ˆæ¶æ§‹**     | åˆ†å‡º `Core`ã€`Infrastructure`ã€`ConsoleRunner` | å»ºç«‹ solution ä¸¦åŠ å…¥å°ˆæ¡ˆåƒè€ƒ                  |
| **2ï¸âƒ£ Binance API å®¢æˆ¶ç«¯** | å¾ Binance å–å¾—æ­·å²è³‡æ–™                        | æ’°å¯« `BinanceApiClient` + `BinanceDataMapper` |
| **3ï¸âƒ£ ç­–ç•¥å¼•æ“**           | å¯¦ä½œ `StrategyBase` èˆ‡ä¸€å€‹åŸºæœ¬ç­–ç•¥ï¼ˆå¦‚å‡ç·šï¼‰   | å»ºç«‹ `IStrategy` èˆ‡ç­–ç•¥å¯¦ä¾‹                   |
| **4ï¸âƒ£ å›æ¸¬æ¨¡çµ„**           | æ’°å¯« `BacktestEngine` + æ•ˆèƒ½åˆ†æ               | åŠ å…¥ Stopwatch æˆ– BenchmarkDotNet             |
| **5ï¸âƒ£ æ•ˆèƒ½æ¸¬è©¦**           | åˆ†æå›æ¸¬ç“¶é ¸                                   | ä½¿ç”¨ `PerformanceTimer.MeasureAsync()`        |
| **6ï¸âƒ£ çµæœå ±å‘Š**           | è¨ˆç®—ç¸½å ±é…¬ã€å‹ç‡ã€æœ€å¤§å›æ’¤                     | å¯¦ä½œ `PerformanceAnalyzer`                    |
| **7ï¸âƒ£ æ“´å……æ–¹å‘**           | æ”¯æ´å¤šå¹£ç¨® / å¤šç­–ç•¥                            | å¯åŠ å…¥ä½µç™¼è™•ç†èˆ‡å¿«å–æ©Ÿåˆ¶                      |

## 7. æ•ˆèƒ½å„ªåŒ–æ–¹å‘

| å•é¡Œ                 | è§£æ³•                                  |
| -------------------- | ------------------------------------- |
| API è³‡æ–™å¤ªå¤šã€æ‹‰å–æ…¢ | åˆ†æ®µè«‹æ±‚ + ä¸¦è¡Œä¸‹è¼‰ï¼ˆ`Task.WhenAll`ï¼‰ |
| è¨ˆç®—éç¨‹ CPU åƒé‡    | ä½¿ç”¨ `Parallel.ForEach` æˆ–åˆ†æ‰¹è™•ç†    |
| IO éå¤š              | å°‡ Candle å¿«å–åˆ°æœ¬åœ° JSON æª”          |
| æƒ³æŒçºŒåˆ†ææ•ˆèƒ½       | åŠ å…¥ `BenchmarkDotNet` å°ˆæ¡ˆ           |

## âš™ï¸ 8. Performance Analysis æ•ˆèƒ½åˆ†æå»ºè­°

| ğŸ§© ç›®æ¨™ / å±¤é¢               | ğŸ¯ åˆ†æé‡é»                                     | ğŸ§° æ¨è–¦å·¥å…· / æ–¹æ³•                                             | ğŸ’¡ èªªæ˜èˆ‡æ‡‰ç”¨å ´æ™¯                                                                                      |
| ---------------------------- | ----------------------------------------------- | -------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| **CPU / è¨ˆç®—æ•ˆèƒ½**           | æ‰¾å‡ºæœ€è€—æ™‚çš„å‡½å¼ã€æ¼”ç®—æ³•ã€ç­–ç•¥é‹ç®—æ˜¯å¦å¯å¹³è¡ŒåŒ–  | `BenchmarkDotNet`, `dotnet-trace`, **Visual Studio Profiler**  | æ¯”è¼ƒä¸åŒç­–ç•¥çš„é€Ÿåº¦ã€è¨ˆç®—ç“¶é ¸èˆ‡å¹³è¡ŒåŒ–å¯è¡Œæ€§ã€‚BenchmarkDotNet é©åˆåšå¾®è§€æ¯”è¼ƒï¼›VS Profiler é©åˆæ•´é«”åˆ†æã€‚ |
| **è¨˜æ†¶é«” / GC åˆ†æ**         | æª¢æŸ¥å“ªè£¡é »ç¹åˆ†é…å°è‡´ GCã€æ˜¯å¦æœ‰æš«å­˜ç‰©ä»¶é‡è¤‡å»ºç«‹ | `dotnet-counters`, `dotMemory`, **PerfView**                   | è§€å¯Ÿå›æ¸¬éç¨‹çš„ GC æ¬¡æ•¸ã€è¨˜æ†¶é«”å³°å€¼ã€‚ç‰¹åˆ¥é©åˆåµæ¸¬ Candle ç‰©ä»¶æˆ– List<> é‡è¤‡é…ç½®å•é¡Œã€‚                   |
| **I/O / ç¶²è·¯æ•ˆèƒ½**           | Binance API å‘¼å«å»¶é²ã€JSON è§£æé–‹éŠ·             | `dotnet-trace`, `HttpClientFactory`, `System.Diagnostics`      | æª¢æŸ¥ API è«‹æ±‚æ™‚é–“èˆ‡ JSON ååºåˆ—åŒ–è€—æ™‚ã€‚å¯åˆ©ç”¨ `System.Diagnostics.Activity` æ¨™è¨˜ API latencyã€‚         |
| **æ•´é«” CPU/Memory**          | ç›£æ§å›æ¸¬é‹è¡Œæ™‚çš„ CPU / è¨˜æ†¶é«”è®ŠåŒ–               | `dotnet trace`, `dotnet-counters`                              | åˆ†ææ•´é«”æ•ˆèƒ½ç“¶é ¸ã€æ‰¾å‡ºæ˜¯å¦ CPU-bound æˆ– memory-boundã€‚å¯é•·æ™‚é–“ç›£æ§æ•´å€‹å›æ¸¬éç¨‹ã€‚                       |
| **æ–¹æ³•å±¤ç´šè€—æ™‚åˆ†æ**         | æª¢æŸ¥å“ªå€‹æ–¹æ³•æœ€è€—æ™‚                              | `dotnet-counters monitor`                                      | ä»¥å³æ™‚ CLI æ–¹å¼é¡¯ç¤ºç•¶å‰æœ€è€—è³‡æºçš„å‡½å¼å€å¡Šã€‚é©åˆå¿«é€Ÿå®šä½ Hot Pathã€‚                                     |
| **å¾®è§€æ™‚é–“åˆ†æ**             | æ¸¬é‡å–®ä¸€ç­–ç•¥æˆ–å–®ä¸€æ–¹æ³•åŸ·è¡Œæ™‚é–“                  | `Stopwatch`ï¼ˆå°è£ç‚º `PerformanceTimer`ï¼‰                       | ç”¨æ–¼ç´°ç¯€ç´šæ•ˆèƒ½åˆ†æï¼Œä¾‹å¦‚ç­–ç•¥é‹ç®—è¿´åœˆçš„å¹³å‡è€—æ™‚ã€‚ä½å¹²æ“¾ã€å¯å³æ™‚å°å‡ºçµæœã€‚                               |
| **æ‰¹æ¬¡æ•ˆèƒ½æ¸¬è©¦ / ç­–ç•¥å°æ¯”**  | æ¯”è¼ƒå¤šå€‹ç­–ç•¥æˆ–åƒæ•¸çµ„åˆçš„åŸ·è¡Œé€Ÿåº¦                | `BenchmarkDotNet` æˆ–è‡ªå¯«è¿´åœˆ + å¹³å‡è€—æ™‚è¨ˆç®—                    | ç”¨æ–¼ç­–ç•¥å„ªåŒ–èˆ‡å¤šçµ„æ¸¬è©¦ï¼Œæ¯”è¼ƒã€Œä¸åŒåƒæ•¸çµ„åˆã€çš„å¹³å‡å›æ¸¬æ™‚é–“èˆ‡è³‡æºæ¶ˆè€—ã€‚                                 |
| **å¹³è¡ŒåŒ–èˆ‡å¤šåŸ·è¡Œç·’æ•ˆç‡**     | æª¢æ¸¬å¤šä»»å‹™ä¸¦è¡Œå›æ¸¬çš„ CPU åˆ©ç”¨ç‡                 | `dotnet-counters`, `System.Threading.Channels`                 | é©—è­‰æ˜¯å¦æœ‰æ•ˆåˆ©ç”¨å¤šæ ¸å¿ƒ CPUã€‚è§€å¯Ÿ ThreadPool èˆ‡ Task è² è¼‰æƒ…æ³ã€‚                                         |
| **ç³»çµ±ç´šé•·æœŸç›£æ§ï¼ˆéƒ¨ç½²å¾Œï¼‰** | é•·æœŸç›£æ§æœå‹™ CPUã€Memoryã€IO ç‹€æ…‹               | Windows Performance Monitor, **Grafana + Prometheus / Zabbix** | è‹¥æœªä¾†éƒ¨ç½²æˆé•·æ™‚é–“æœå‹™ï¼ˆä¾‹å¦‚è‡ªå‹•å›æ¸¬æ’ç¨‹ï¼‰ï¼Œå¯é€éç³»çµ±ç´šç›£æ§è¿½è¹¤æ•ˆèƒ½è¶¨å‹¢ã€‚                             |

## âœ… 9. Summary ç¸½çµ

| é¢å‘             | å»ºè­°                                       |
| ---------------- | ------------------------------------------ |
| æ˜¯å¦éœ€è¦ DBï¼Ÿ    | âŒ ä¸éœ€è¦ã€‚ç›´æ¥ç”¨ Binance API æ‹¿è³‡æ–™å³å¯ã€‚ |
| API è³‡æ–™å–å¾—ä½ç½® | Infrastructure å±¤ï¼ˆèˆ‡å¤–éƒ¨ä¸–ç•Œäº’å‹•ï¼‰        |
| å›æ¸¬é‚è¼¯æ”¾å“ªï¼Ÿ   | Core å±¤ï¼ˆç´”æ¼”ç®—æ³•èˆ‡é‚è¼¯ï¼‰                  |
| æ•ˆèƒ½æ¸¬è©¦åœ¨å“ªåšï¼Ÿ | ConsoleRunner å±¤ï¼ˆå¯è¦–åŒ– + Stopwatchï¼‰     |
| æœªä¾†è¦æ“´å±•ï¼Ÿ     | åŠ ä¸Š WebAPI / Scheduler / ReportService    |
